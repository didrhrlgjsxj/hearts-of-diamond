### `unitLogic.js` 파일 기능 설명

이 파일은 게임의 '두뇌'와 같은 역할을 합니다. `main.js`의 게임 루프에서 호출되어, 게임에 존재하는 모든 부대들의 상태를 업데이트하고 상호작용을 처리하는 모든 복잡한 로직을 수행합니다.

---

#### **주요 기능 및 로직 흐름 (`updateUnits` 함수)**

이 파일의 핵심은 `updateUnits` 함수이며, 다음과 같은 순서로 동작합니다.

1.  **상태 초기화**:
    *   매 프레임 시작 시, 모든 부대의 `isInCombat`(전투 중)과 `isEnemyDetected`(적 탐지) 상태를 `false`로 초기화합니다.
    *   이전 프레임의 시각 효과(예광탄 등)를 초기화합니다.

2.  **적 탐지 및 목표 설정 (최상위 부대 단위)**:
    *   각 아군 부대(최상위 기준)는 모든 적 부대와의 거리를 계산합니다.
    *   자신의 `detectionRange`(정찰력에 기반한 탐지 범위) 안에 적이 한 명이라도 들어오면, `isEnemyDetected` 상태가 `true`가 됩니다. 이 상태는 아이콘에 녹색 테두리를 표시하는 데 사용됩니다.
    *   가장 가까운 적 부대를 찾아, 그 방향으로 자신의 진형 방향(`direction`)을 설정합니다. 이는 부대가 항상 위협적인 방향을 주시하게 만듭니다.

3.  **전투 로직 (개별 전투 부대 단위)**:
    *   탐지와 별개로, 실제 전투는 **중대(Company)**와 같은 개별 전투 부대(`combatSubUnits`)를 기준으로 일어납니다.
    *   각 아군 전투 부대는 자신의 `engagementRange`(교전 범위) 내에서 가장 가까운 적 전투 부대를 찾아 공격 대상으로 삼습니다.
    *   **교전 시작**:
        *   아군과 적군 부대 모두 `isInCombat` 상태가 `true`로 변경됩니다.
        *   **피해 계산**: 공격자의 화력, 대인/대물 공격력과 방어자의 장갑, 조직력 상태를 종합하여 `takeDamage` 메서드를 호출, 피해를 입힙니다.
        *   예광탄(`tracer`) 시각 효과를 생성합니다.

4.  **이동 로직**:
    *   **이동 명령 전파**: 지휘 부대(`Brigade`, `Battalion`)는 자신의 `updateMovement`를 통해 이동 목표(`destination`)를 본부 중대(`hqUnit`)에게 전달합니다.
    *   **개별 이동 처리**: 루프의 마지막 부분에서 모든 유닛(독립 중대, 지휘 부대의 본부 중대, 모든 전투 중대)의 `updateMovement` 함수를 각각 호출하여 실제 위치 이동을 처리합니다. 이로써 모든 유닛이 일관된 로직으로 움직입니다.
    *   **진형 유지**: 전투 중이 아닐 때, 지휘 부대는 `updateCombatSubUnitPositions`를 호출하여 휘하 전투 중대들이 본부를 중심으로 정해진 진형을 유지하도록 각자의 목표 위치를 계속 갱신합니다.

5.  **조직력 회복**:
    *   전투 중이 아닌 부대는 시간이 지남에 따라 손실된 조직력(`organization`)을 서서히 회복합니다.

---

#### **보조 함수**

*   **`findClosestEnemySubUnit(friendlySubUnit, allTopLevelUnits)`**:
    *   특정 아군 전투 부대를 기준으로, 교전 범위 내에서 가장 가까운 적 전투 부대를 찾아 반환하는 매우 중요한 함수입니다.

*   **`cleanupDestroyedUnits(topLevelUnits, selectedUnit)`**:
    *   병력(`currentStrength`)이 0 이하가 된 부대를 게임 월드에서 제거하는 역할을 합니다. 만약 선택된 유닛이 파괴되면 선택 상태도 해제합니다.

---

요약하자면, `unitLogic.js`는 **부대들의 자율적인 행동(AI)을 구현**하는 파일입니다. 플레이어의 명령(이동)을 기반으로 하되, 적을 만나면 스스로 판단하여 전투 대형을 갖추고 교전하며, 전투가 끝나면 조직력을 회복하는 등 살아있는 부대처럼 행동하게 만드는 모든 로직이 여기에 집중되어 있습니다.